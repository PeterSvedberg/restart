<!--
@license
The MIT License applies unless otherwise noted. See LICENSE.md for details.
Copyright (c) 2015 Peter Svedberg.
-->
<link rel="import" href="../../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="data-surface">
  <template>
    <iron-localstorage name="persisted-actionables" value="{{actionables}}"
      on-iron-localstorage-load-empty="_initialDefaultActionables">
    </iron-localstorage>
  </template>

<script src="../../scripts/dataSurface.js"></script>

<script>
  'use strict';
  
  class Actionable {
    constructor(id, title) {
      this.id = id;
      this.timestamp = Date.now();
      this.title = title;
      this.text = '';
      this.containers = [];
    }
  }
    
  class Container {
    constructor(id, title) {
      this.id = id;
      this.title = title;
      this.text = '';
      this.link = '';
    }
  }
    
  (function() {
    class DataSurface {
      beforeRegister() {
        this.is = 'data-surface';
        
        this.properties = {
          actionables: {
            type: Array,
            notify: true,
            value: () => []
          },
          
          selectedActionable: {
            type: Object,
            notify: true,
            value: () => {}
          },
        };       
      }
      
      attached() {
        addEventListener('create-actionable-action', e => {
          this.createActionable(e.detail.title);
        });
        addEventListener('add-container-action', e => {
          this.createContainer(e.detail.actionableId, e.detail.name);
        });
        addEventListener('actionable-name-change-action', e => {
          this.changeActionableName(e.detail.actionable);
        });
        addEventListener('container-name-change-action', e => {
          this.changeContainerName(e.detail);
        });
        addEventListener('container-link-change-action', e => {
          this.changeContainerLink(e.detail);
        });
        addEventListener('actionable-text-change-action', e => {
          this.changeActionableText(e.detail);
        });
        addEventListener('delete-actionable-action', e => {
          this.deleteActionable(e.detail.id);
        });
        addEventListener('delete-container-action', e => {
          this.deleteContainer(e.detail.actionableId, e.detail.container);
        });
        this.fire('dataSurfaceReady', {bubbles: false});
        console.log('Data surface is attached');
      }
      
      detached() {
        // TODO this is never getting called
        window.alert('detaching data-surface');
        console.log('detaching');
        removeEventListener('actionable-name-change-action', () => {
          console.log('removeEventListener, actionable-name-change-action');
        });
      }
      
      _getId() {
        let id;
        if (window.crypto === undefined) {
          id = Math.random() + '';
          id = id.substring(2);
        } else {
          id = window.crypto.getRandomValues(new Uint32Array(2));
          id = `${id[0]}${id[1]}`;
        }
        return id;
      }
      
      _initialDefaultActionables() {
          var initial = [{
            'id': 'One',
            'timestamp': 1446119424988,
            'title': 'Daily',
            'text': '',
            'containers': []
           }, {
            'id': 'Two',
            'timestamp': 1446119424988,
            'title': 'News',
            'text': '',
            'containers': []
           }, {
            'id': 'Three',
            'timestamp': 1446119424988,
            'title': 'Weather',
            'text': '',
            'containers': []
          }];
          this.set('actionables', initial);
      }
  
      setActionables(actionables) {
        this.actionables = actionables;
      }
  
      // Actions
      createActionable(name) {
        let a = new Actionable(this._getId(), name);
        this.unshift('actionables', a);
        this.set('selectedActionable', a);
        window.location.hash = `!${a.id}`;
        this.fire('navigation-event', {'bubbles': false});
        // Hook for backend?
        console.log('createdActionable');
        this.fire('createdActionable', {'actionable': a});
      }
        
      createContainer(actionableId, name) {
        if (this.selectedActionable.id !== actionableId) {
          console.log('Actionable id mismatch on add container action');
          return;
        }
        this.set('selectedActionable.timestamp', Date.now());
        let c = new Container(this._getId(), name);
        this.unshift('selectedActionable.containers', c);
        // Hook for backend?
        this.fire('addedContainer', {'container': c});
      }
        
      changeActionableName(actionable) {
        // Hook for backend?
        this.fire('changedActionableName', {'actionable': actionable});
      }
        
      changeContainerName(handle) {
        // Hook for backend?
        this.fire('changedContainerName', {'actionable': handle.actionable, 'newContainer': handle.newContainer});
      }
        
      changeContainerLink(handle) {
        // Hook for backend?
        this.fire('changedContainerLink', {'actionable': handle.actionable, 'newContainer': handle.newContainer});
      }
        
      changeActionableText(handle) {
        // Hook for backend?
        this.fire('changedActionableText', {'actionable': handle.actionable});
      }
        
      deleteActionable(id) {
        if (id === this.selectedActionable.id) {
          this.arrayDelete('actionables', this.selectedActionable);
          console.log('TODO Remove item from history.');
          window.history.back();
          this.fire('navigation-event', {'bubbles': false});
          // Hook for backend?
          this.fire('deletedActionable', {'actionable': this.selectedActionable});
        } else {
          console.log('deleteActionable, id mismatch! id:' + id + 'this.selectedActionable.id:' + this.selectedActionable.id + '!');
        }
      }
      
      deleteContainer(actionableId, container) {
        if (actionableId === this.selectedActionable.id) {
          this.arrayDelete('selectedActionable.containers', container);
          // Hook for backend?
          this.fire('deletedContainer', {'actionableId': actionableId, 'container': container});
        } else {
          console.log('deleteContainer, id mismatch! actionableId:' + actionableId + 'this.selectedActionable.id:' + this.selectedActionable.id + '!');
        }
      }

    }
    
    new Polymer(DataSurface);
    
  })();
</script>
</dom-module>

