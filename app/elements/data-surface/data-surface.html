<!--
@license
The MIT License applies unless otherwise noted. See LICENSE.md for details.
Copyright (c) 2015 Peter Svedberg.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="data-surface"></dom-module>

<script src="../../scripts/dataSurface.js"></script>
<script>
  'use strict';

  class Actionable {
    constructor(id, title) {
      this.id = id;
      this.title = title;
      this.text = '';
      this.containers = () => [];
    }
  }
  
  (function() {
    class DataSurface {
      beforeRegister() {
        this.is = 'data-surface';
        
        this.properties = {
          actionables: {
            type: Array,
            notify: true,
            value: () => []
          },
          
          selectedActionable: {
            type: Object,
            notify: true,
            value: () => {}
          },
          
          hashValue: {
            type: String
          }
        };       
      }
      
      attached() {
        this.fire('dataSurfaceReady', {bubbles: false});
        console.log('Data surface is attached');
        if (this.setHashValue()) {
          console.log('We have an actionable to load ' + this.hashValue);
          this.loadActionable();
        }
      }
      
      setHashValue() {
        var hash = window.location.hash;
        if (hash.length < 3) {
          return false;
        }
        this.hashValue = hash.substring(2, hash.length);
        return true;
      }
      
      loadActionable() {
        for (let a of this.actionables) {
          if (a.id === this.hashValue) {
            this.selectedActionable = a;
            break;
          }
        }
      }
      
      _getId() {
        let id;
        if (window.crypto === undefined) {
          id = Math.random() + '';
          id = id.substring(2);
        } else {
          id = window.crypto.getRandomValues(new Uint32Array(2));
          id = `${id[0]}${id[1]}`;
        }
        return id;
      }
      
      getActionables() {
        return this.actionables;
      }
      
      setActionables(actionables) {
        this.actionables = actionables;
      }
  
      // Actions
      createActionable(name) {
        let a = new Actionable(this._getId(), name);
        this.unshift('actionables', a);
        this.set('selectedActionable', a);
        // Hook for backend?
        this.fire('createdActionable', {actionable: a, bubbles: false});
      }
        
      changeActionableName(actionable) {
        // Do persistence...
        // Hook for backend?
        this.fire('changedActionableName', {actionable: actionable, bubbles: false});
      }
        
      deleteActionable(id) {
        if (id === this.selectedActionable.id) {
          this.arrayDelete('actionables', this.selectedActionable);
          this.set('selectedActionable', null);
          // TODO remove item from history
          window.history.back();
          // Hook for backend?
          this.fire('deletedActionable', {id: id, bubbles: false});
        } else {
          console.log('deleteActionable, id mismatch! id:' + id + 'this.selectedActionable.id:' + this.selectedActionable.id + '!');
        }
      }
    }
    
    new Polymer(DataSurface);
    
  })();
</script>


